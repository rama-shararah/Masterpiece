@model MasterPieceMVC.Models.Subscriper

@{
    ViewBag.Title = "SingleSub";
    Layout = "~/Views/Shared/MyLayout.cshtml";


}

<style>
    #row {
        text-align: right;
        border: solid #E6E6E6 1px;
        border-radius: 4px;
        width: 100%;
    }

    .card-body {
        border-top: 1px #E6E6E6 solid;
    }

    #text {
        font-size: 20px;
    }

    .link-muted {
        color: #aaa;
    }

        .link-muted:hover {
            color: #1266f1;
        }

    .me-3 {
        margin-left: 1rem;
    }

    .checked {
        color: orange;
    }

    @@media (min-width: 1200px) {
        .col-xl-7 {
            flex: 0 0 auto;
            width: 100%;
        }
    }

    .con {
        display: flex;
    }

    ::placeholder {
        text-align: right;
    }

    .coment-bottom {
        border: 1px solid #E6E6E6;
        border-radius: 10px;
        margin:0% 5% 5% 5%;
    }
</style>


<br />
<br />


<div class="container">
    <div id="row" class="row">

        <div id="text" class="col-md-7">
            <div class="p-3 py-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                </div>
                <div class="row mt-2">
                    <div class="col-md-8">
                        <div style="text-align: right;">
                            @{
                                MasterPieceMVC.Models.MyMasterPieceEntities db = new MasterPieceMVC.Models.MyMasterPieceEntities();
                                var count = db.Comments.Where(x => x.Subscriper_Id == Model.Subscriper_Id).Select(x => x.Rate).ToList().Count();
                                var sum = db.Comments.Where(x => x.Subscriper_Id == Model.Subscriper_Id).Select(x => x.Rate).ToList().Sum();
                                
                                if (count == 0)
                                {
                                    count = 1;
                                }
                                var avr = sum / count;


                            }
                            @for (int i = 0; i < avr; i++)
                            {
                                <span class="fa fa-star checked"></span>
                            }
                            @for (int i = 0; i < (5 - avr); i++)
                            {
                                <span class="fa fa-star"></span>
                            }


                        </div>
        </div>
             
                    <div class="col-md-4">
                        التقييم
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-8">
                        @Model.AspNetUser.Location

                    </div>
                    <div class="col-md-4">
                        مكان الاقامة
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-8">
                        @Model.AspNetUser.PhoneNumber
                    </div>
                    <div class="col-md-4">
                        رقم الهاتف
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-8">
                        @Model.AverageHourlyRate
                    </div>
                    <div class="col-md-4">
                        متوسط سعر الساعة
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-8">
                        @Model.Beg_Time - @Model.End_Time
                    </div>
                    <div class="col-md-4">
                        ساعات العمل
                    </div>
                </div>
                @{
                    var id = Model.Subscriper_Id;
                    
                    var numOfClient = db.Requests.Where(x => x.Subscriper_Id == id).Count();
                }
                <div class="row mt-3">
                    <div class="col-md-8">
                        @numOfClient

                    </div>
                    <div class="col-md-4">
                        عدد العملاء
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-8">
                        <p>@Model.Service_Description</p>

                    </div>
                    <div class="col-md-4">
                        وصف الخدمة
                    </div>
                </div>
                @{
                    var user = User.Identity.Name;
                    var himself = db.Subscripers.FirstOrDefault(x => x.Subscriper_Id == Model.Subscriper_Id).AspNetUser.Email;
                 }
                <div class="row mt-3">
                    <div class="col-md-8">
                        @{ if (User.IsInRole("ServiceProvider") || User.IsInRole("User"))
                            {

                                if (user == himself)
                                {

                                }
                                else
                                {
                                    <a class="btn btn-success launch" data-toggle="modal" data-target="#staticBackdrop">
                                        طلب الخدمة
                                    </a>
                                }

                            }
                            else
                            {
                                Session["id"] = Model.Subscriper_Id;
                                <a class="btn btn-success launch" href="/Account/Login">
                                    طلب الخدمة
                                </a>
                            }
                        }

                    </div>
                    <div class="col-md-4">
                    </div>
                </div>
                <div class="mt-5 text-right">
                </div>
            </div>
        </div>

        <div data-inviewport="scale" class="card col-md-5" style="width: 33.709rem; border-radius: 0px">
            <img src="~/pic/@Model.Subscriper_Photo" style="height:27rem" class="card-img-top" alt="...">
            <div class="card-body">
                <p class="card-text">@Model.Last_Name @Model.First_Name</p>
                <p style="font-size: 14px;" class="card-text">@Model.Service.Service_Name</p>

            </div>
        </div>
    </div>
</div>
<br />
<br />
@{
  
    
    var users = db.AspNetUsers.FirstOrDefault(s => s.Email == user);
}
<div class="container">
    <h2 class="container" style="text-align: right;">الآراء و التعليقات</h2>
</div>
<section>
    <div class="container my-5 py-5 text-dark">
        <div class="row d-flex justify-content-center">
            @if (User.IsInRole("ServiceProvider") || User.IsInRole("User"))
            {
                if (user == himself)
                {
                }
                else
                {

                    using (Html.BeginForm("Comment", "Comments", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        @Html.AntiForgeryToken()
                        <div class="coment-bottom bg-white p-2 px-4">

                            <div class="d-flex flex-row add-comment-section mt-4 mb-4">

                                <input class="btn btn-success" style="width: 15%; margin-right: 1rem;" value="تعليق" type="submit">
                                <input type="text" name="Comment1" class="form-control mr-3" placeholder="اضف تعليق">
                                <input hidden name="Subscriper_Id" type="number" value="@Model.Subscriper_Id" />

                                <img class="rounded-circle shadow-1-strong me-3"
                                     src="~/pic/@users.Photo" alt="" width="55"
                                     height="55" />




                            </div>
                            <style>

                                #ratee {
                                    text-align: right;
                                    margin-right: 5.5rem;
                                }

                                .rating {
                                    display: inline-block;
                                    direction: rtl;
                                }

                                    .rating input {
                                        display: none;
                                    }

                                    .rating label {
                                        font-size: 25px;
                                        color: #ddd;
                                        cursor: pointer;
                                    }

                                        .rating label:hover,
                                        .rating label:hover ~ label,
                                        .rating input:checked ~ label {
                                            color: #ffdd00;
                                        }
                            </style>
                            <div id="ratee">

                                <div class="rating">
                                    <input type="radio" id="star5" name="rating" value="5" />
                                    <label for="star5" title="5 stars">&#9733;</label>
                                    <input type="radio" id="star4" name="rating" value="4" />
                                    <label for="star4" title="4 stars">&#9733;</label>
                                    <input type="radio" id="star3" name="rating" value="3" />
                                    <label for="star3" title="3 stars">&#9733;</label>
                                    <input type="radio" id="star2" name="rating" value="2" />
                                    <label for="star2" title="2 stars">&#9733;</label>
                                    <input type="radio" id="star1" name="rating" value="1" />
                                    <label for="star1" title="1 star">&#9733;</label>
                                </div>
                                : تقييم
                            </div>
                            <script>
                                function getRating() {
                                    var rating = 0;
                                    var elements = document.getElementsByName("rating");
                                    for (var i = 0; i < elements.length; i++) {
                                        if (elements[i].checked) {
                                            rating = elements[i].value;
                                            break;
                                        }
                                    }
                                    return rating;
                                }
                            </script>

                        </div>
                    }
                }
            }
            <div class="col-md-11 col-lg-9 col-xl-7">
                @{

                    var comment = db.Comments.Where(x => x.Accept == true).Where(x => x.Subscriper_Id == Model.Subscriper_Id).ToList();
                }
                @foreach (var item in comment)
                {
                    <div class="d-flex flex-start mb-4">
                        <div class="card w-100">
                            <div class="card-body p-4">
                                <div class="con">
                                    <div class="col-md-3" style="text-align: right;">
                                        @for (int i = 0; i < item.Rate; i++)
                                        {
                                            <span class="fa fa-star checked"></span>
                                        }
                                        @for (int i = 0; i < (5 - item.Rate); i++)
                                        {
                                            <span class="fa fa-star"></span>
                                        }
                                    </div>
                                    <div class="col-md-9">
                                        <h5>@item.AspNetUser.Email</h5>
                                        <p class="small">@item.Comment_Date</p>
                                        <p>
                                            @item.Comment1
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <img class="rounded-circle shadow-1-strong me-3"
                             src="~/pic/@item.AspNetUser.Photo" alt="avatar" width="65"
                             height="65" />

                    </div>
                }



            </div>
        </div>

    </div>

</section>
<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-right"><i class="fa fa-close close" data-dismiss="modal"></i></div>
                <div class="tabs mt-3">

                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="visa" role="tabpanel" aria-labelledby="visa-tab">
                            <div class="mt-4 mx-4">
                                <div class="text-center">
                                    <h5>هل انت متأكد و تريد الاستمرار بطلب الخدمة ؟ </h5>
                                    <br />
                                    <h6>بعد الضغط على زر تأكيد طلب الخدمة سيصل اشعار لمقدم الخدمة بموقعك و رقم هاتفك </h6>
                                    <hr />
                                    <button id="getLocationBtn" class="btn btn-success">تأكيد طلب الخدمة</button>
                                </div>

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
        $(document).ready(function () {
            $('#getLocationBtn').click(function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            });
        });

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            $('#lat').val(latitude);
            $('#lng').val(longitude);
            $('form').submit();
        }


    </script>
}

@using (Html.BeginForm("SaveLocation", "Requests", FormMethod.Post))
{
    @Html.Hidden("lat", null, new { id = "lat" })
    @Html.Hidden("lng", null, new { id = "lng" })
    <input hidden name="Subscriper_Id" type="number" value="@Model.Subscriper_Id" />
    <input hidden type="submit" value="Save location" />
}



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>